name: GitFlow PR Guards

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate source branch for GitFlow
        shell: bash
        run: |
          set -euo pipefail

          BASE_REF="${{ github.base_ref }}"
          HEAD_REF="${{ github.head_ref }}"

          echo "Base: ${BASE_REF}"
          echo "Head: ${HEAD_REF}"

          # Helper: bash regex match
          matches() {
            local value="$1"
            local regex="$2"
            [[ "$value" =~ $regex ]]
          }

          if [[ "$BASE_REF" == "main" ]]; then
            # Allow hotfixes to go directly into main
            if matches "$HEAD_REF" '^hotfix\/.+'; then
              echo "OK: hotfix/* -> main"
              exit 0
            fi

            echo "ERROR: PRs targeting 'main' must come from 'hotfix/*'."
            echo "       Current head branch: '${HEAD_REF}'"
            exit 1
          fi

          if [[ "$BASE_REF" == "develop" ]]; then
            # Standard GitFlow: develop accepts feature/*, release/*, and hotfix/* (back-merge)
            if matches "$HEAD_REF" '^(feature|release|hotfix)\/.+'; then
              echo "OK: (feature|release|hotfix)/* -> develop"
              exit 0
            fi

            echo "ERROR: PRs targeting 'develop' must come from 'feature/*', 'release/*', or 'hotfix/*'."
            echo "       Current head branch: '${HEAD_REF}'"
            exit 1
          fi

          echo "No GitFlow guard configured for base branch '${BASE_REF}'. Skipping."
          exit 0
